# n8n Workflow Setup Guide

Complete guide for setting up the automated solution suggestion workflow in n8n.

## Overview

When AI Analyzer creates a GitHub issue, n8n automatically:
1. Gets triggered via GitHub webhook
2. Reads the issue details
3. Fetches relevant code from repository
4. Uses AI to analyze and suggest solutions
5. Posts solution as a comment on the issue

## Prerequisites

- n8n instance: https://n8n.easytechinnovate.site/
- GitHub repository with issues enabled
- GitHub Personal Access Token
- OpenAI API key

## Step-by-Step Setup

### Step 1: Access n8n

1. Go to https://n8n.easytechinnovate.site/
2. Login to your account
3. Click "New Workflow"

### Step 2: Add GitHub Webhook Trigger

1. **Add Node:** Click "+" ‚Üí Search "GitHub Trigger"
2. **Configure:**
   - **Repository Owner:** Your GitHub username
   - **Repository Name:** Your repo name (e.g., "montitor")
   - **Events:** Select "issues"
   - **Credential:** Click "Create New Credential"

3. **Setup GitHub Credential:**
   - Go to https://github.com/settings/tokens
   - Click "Generate new token (classic)"
   - Scopes needed:
     - ‚úÖ `repo` (Full control of repositories)
     - ‚úÖ `admin:repo_hook` (Full control of webhooks)
   - Generate token
   - Copy token (starts with `ghp_`)
   - Paste in n8n credential

4. **Save Node**

### Step 3: Filter for "Opened" Issues

We only want to process newly opened issues.

1. **Add Node:** "IF"
2. **Connect:** GitHub Trigger ‚Üí IF
3. **Configure:**
   - **Condition 1:**
     - Value 1: `{{ $json.action }}`
     - Operation: `equals`
     - Value 2: `opened`

### Step 4: Extract Issue Data

1. **Add Node:** "Set" (rename to "Extract Issue Info")
2. **Connect:** IF (true output) ‚Üí Set
3. **Configure - Add Values:**
   - Name: `issueNumber`, Value: `{{ $json.issue.number }}`
   - Name: `issueTitle`, Value: `{{ $json.issue.title }}`
   - Name: `issueBody`, Value: `{{ $json.issue.body }}`
   - Name: `repoOwner`, Value: `{{ $json.repository.owner.login }}`
   - Name: `repoName`, Value: `{{ $json.repository.name }}`

### Step 5: Read Code Files

We need to fetch the relevant code files.

1. **Add Node:** "HTTP Request" (rename to "Read Code Files")
2. **Connect:** Extract Issue Info ‚Üí HTTP Request
3. **Configure:**
   - **Method:** GET
   - **URL:** `https://api.github.com/repos/{{ $node["Extract Issue Info"].json.repoOwner }}/{{ $node["Extract Issue Info"].json.repoName }}/contents/app`
   - **Authentication:** Generic Credential Type ‚Üí Header Auth
     - **Name:** Authorization
     - **Value:** `Bearer YOUR_GITHUB_TOKEN`

**Alternative - Read specific files:**

Add multiple HTTP Request nodes for specific files:
- `app/index.js`
- `app/logger.js`
- `app/otel.js`

### Step 6: AI Analysis with OpenAI

1. **Add Node:** "OpenAI"
2. **Connect:** Read Code Files ‚Üí OpenAI
3. **Configure:**
   - **Resource:** Chat
   - **Operation:** Message a Model
   - **Model:** gpt-4-turbo-preview (or gpt-3.5-turbo for lower cost)
   - **Credential:** Add OpenAI API key

4. **Messages:**

**System Message:**
```
You are an expert software engineer analyzing production issues and suggesting solutions. Analyze the GitHub issue and provide actionable solutions with code examples.
```

**User Message:**
```
Analyze this GitHub issue and suggest a detailed solution:

**Issue Title:**
{{ $node["Extract Issue Info"].json.issueTitle }}

**Issue Description:**
{{ $node["Extract Issue Info"].json.issueBody }}

**Repository Structure:**
{{ $node["Read Code Files"].json }}

Please provide:

1. **Root Cause Analysis**
   - What is causing this issue?
   - Why is it happening?

2. **Impact Assessment**
   - How critical is this?
   - What are the consequences?

3. **Immediate Fix**
   - Quick workaround or mitigation
   - Steps to reduce impact now

4. **Long-term Solution**
   - Proper fix for the root cause
   - Code changes needed

5. **Code Example**
   - Show specific code changes
   - Include file paths and line numbers

6. **Testing Steps**
   - How to verify the fix works
   - What to test

Format your response in clear markdown with code blocks.
```

5. **Options:**
   - **Temperature:** 0.3 (for more focused responses)
   - **Max Tokens:** 2000

### Step 7: Format Solution Comment

1. **Add Node:** "Set" (rename to "Format Solution")
2. **Connect:** OpenAI ‚Üí Set
3. **Configure - Add Value:**
   - Name: `comment`
   - Value:
```markdown
## ü§ñ AI-Generated Solution

{{ $node["OpenAI"].json.choices[0].message.content }}

---

### Solution Generated By
- **AI Model:** GPT-4 Turbo
- **Timestamp:** {{ $now }}
- **Workflow:** n8n Automated Analysis

### Next Steps
1. Review the suggested solution carefully
2. Test in a development environment first
3. Create a pull request with the fix
4. Monitor the issue after deployment

*This is an AI-generated suggestion. Please review before implementing.*
```

### Step 8: Post Comment to GitHub

1. **Add Node:** "HTTP Request" (rename to "Post Solution")
2. **Connect:** Format Solution ‚Üí HTTP Request
3. **Configure:**
   - **Method:** POST
   - **URL:** `https://api.github.com/repos/{{ $node["Extract Issue Info"].json.repoOwner }}/{{ $node["Extract Issue Info"].json.repoName }}/issues/{{ $node["Extract Issue Info"].json.issueNumber }}/comments`
   - **Authentication:** Header Auth
     - Name: `Authorization`
     - Value: `Bearer YOUR_GITHUB_TOKEN`
   - **Body Content Type:** JSON
   - **Body:**
```json
{
  "body": "{{ $node[\"Format Solution\"].json.comment }}"
}
```

### Step 9: Error Handling (Optional)

1. **Add Node:** "IF" (rename to "Check for Errors")
2. **Connect:** Post Solution ‚Üí IF
3. **Configure:** Check if response status is 201

4. **Add Node:** "Send Email" or "Slack"
5. **Connect:** IF (false output) ‚Üí Send Email
6. **Configure:** Send notification if comment failed

### Step 10: Activate Workflow

1. Click "Activate" toggle in top right
2. Save workflow with a descriptive name: "AI Issue Solver"

## Testing the Workflow

### Method 1: Manual Test

1. In n8n, click "Listen for Test Event" on GitHub Trigger node
2. Create a test issue manually in GitHub:
   - Title: "Test Issue for n8n"
   - Body: "Testing automated workflow"
   - Label: "test"
3. Check n8n execution log
4. Verify comment appears on issue

### Method 2: End-to-End Test

1. Ensure all services running:
   ```bash
   # Terminal 1
   cd app && npm start

   # Terminal 2
   cd github-service && npm start

   # Terminal 3
   cd ai-analyzer && npm start
   ```

2. Generate errors:
   ```bash
   for i in {1..15}; do curl http://localhost:3000/error; sleep 2; done
   ```

3. Wait 5-15 minutes for AI Analyzer to detect and create issue

4. Check GitHub for:
   - New issue created by AI Analyzer
   - Solution comment posted by n8n

## Workflow JSON (Import Ready)

Save this as `ai-issue-solver.json` and import into n8n:

```json
{
  "name": "AI Issue Solver",
  "nodes": [
    {
      "parameters": {
        "authentication": "oAuth2",
        "owner": "={{ $json.repository.owner.login }}",
        "repository": "={{ $json.repository.name }}",
        "events": ["issues"]
      },
      "name": "GitHub Issues Trigger",
      "type": "n8n-nodes-base.githubTrigger",
      "typeVersion": 1,
      "position": [240, 300],
      "webhookId": "auto-generated"
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.action }}",
              "value2": "opened"
            }
          ]
        }
      },
      "name": "Issue Opened?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [440, 300]
    },
    {
      "parameters": {
        "values": {
          "string": [
            {"name": "issueNumber", "value": "={{ $json.issue.number }}"},
            {"name": "issueTitle", "value": "={{ $json.issue.title }}"},
            {"name": "issueBody", "value": "={{ $json.issue.body }}"},
            {"name": "repoOwner", "value": "={{ $json.repository.owner.login }}"},
            {"name": "repoName", "value": "={{ $json.repository.name }}"}
          ]
        }
      },
      "name": "Extract Issue Info",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [640, 300]
    }
  ],
  "connections": {
    "GitHub Issues Trigger": {
      "main": [[{"node": "Issue Opened?", "type": "main", "index": 0}]]
    },
    "Issue Opened?": {
      "main": [[{"node": "Extract Issue Info", "type": "main", "index": 0}]]
    }
  }
}
```

## Advanced Configuration

### Read Multiple Files Intelligently

Use a Code node to parse the issue body and extract mentioned file paths:

```javascript
// In Code node
const issueBody = $input.item.json.issueBody;
const filePaths = [];

// Extract file paths from issue (pattern: path/to/file.js)
const matches = issueBody.match(/[\w/-]+\.[\w]+/g);
if (matches) {
  filePaths.push(...matches.filter(f =>
    f.startsWith('app/') || f.startsWith('src/')
  ));
}

// Default files if none found
if (filePaths.length === 0) {
  filePaths.push('app/index.js', 'app/logger.js');
}

return filePaths.map(path => ({ json: { path } }));
```

### Enhanced AI Prompt

```
You are a senior DevOps engineer with expertise in Node.js, Express, and observability.

**Context:**
- Service: {{ $node["Extract Issue Info"].json.serviceName }}
- Issue detected by AI monitoring system
- Production environment

**Issue Details:**
{{ $node["Extract Issue Info"].json.issueBody }}

**Available Code:**
{{ $node["Read Code Files"].json }}

**Your Task:**
Provide a comprehensive solution following this structure:

## üîç Root Cause Analysis
[Explain what's wrong and why]

## üí• Impact Assessment
[Severity, affected users, business impact]

## üöë Immediate Mitigation
[Quick fix to stop the bleeding]
```bash
# Commands to run now
```

## üîß Proper Solution
[Long-term fix]
```javascript
// File: app/index.js
// Changes needed at lines X-Y
```

## ‚úÖ Testing Checklist
- [ ] Test case 1
- [ ] Test case 2

## üìä Monitoring
[What to watch after deploying fix]

Be specific, actionable, and include code examples.
```

### Add Slack Notification

After posting the comment, notify your team:

1. **Add Node:** "Slack"
2. **Configure:**
   - **Channel:** #incidents
   - **Message:**
```
ü§ñ AI Solution Posted

Issue: {{ $node["Extract Issue Info"].json.issueTitle }}
URL: {{ $json.issue.html_url }}

A solution has been automatically generated and posted.
Please review and implement.
```

## Troubleshooting

### Webhook not triggering
- Check workflow is activated
- Verify webhook exists in GitHub repo settings
- Check webhook delivery logs in GitHub

### GitHub API rate limit
- Use authenticated requests
- Implement caching
- Reduce frequency

### AI not generating good solutions
- Improve prompts with more context
- Use GPT-4 instead of GPT-3.5
- Provide more code files
- Include error logs in prompt

### Comment not posting
- Check GitHub token permissions
- Verify issue number is correct
- Check n8n execution logs

## Security Best Practices

1. **Use webhook secrets:** Validate webhook signatures
2. **Limit permissions:** GitHub token should have minimum required scopes
3. **Don't log sensitive data:** Be careful with credentials in logs
4. **Rotate tokens:** Change GitHub and OpenAI tokens regularly

## Cost Optimization

### OpenAI Costs
- Use GPT-3.5-turbo: ~$0.002 per request (vs GPT-4: ~$0.09)
- Cache responses for similar issues
- Set max tokens limit
- Only trigger on high-severity issues

### GitHub API Limits
- Use conditional requests
- Implement rate limit handling
- Cache repository data

## Monitoring the Workflow

### Check Executions

1. In n8n, go to "Executions"
2. View success/failure rates
3. Review execution times
4. Check for errors

### Metrics to Track

- Execution success rate
- Average execution time
- OpenAI API cost
- GitHub API calls
- Issues processed

## Next Steps

- [ ] Test workflow with real issues
- [ ] Monitor execution logs
- [ ] Optimize prompts based on results
- [ ] Add more code file fetching logic
- [ ] Implement error notifications
- [ ] Add automatic PR creation
- [ ] Integrate with Jira/Linear

## Support

If workflow fails:
1. Check n8n execution logs
2. Verify all credentials are valid
3. Test each node individually
4. Check GitHub webhook deliveries
5. Review OpenAI API status

## License

MIT
